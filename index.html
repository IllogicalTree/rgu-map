<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Campus Mapple</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
    integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>
</head>

<body>
  <div id="container">
  </div>
</body>


<script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAt6xLMB2D-IhmjIyS_N4AshN0Ii__qNWM",
    authDomain: "webtest-cffc9.firebaseapp.com",
    databaseURL: "https://webtest-cffc9.firebaseio.com",
    projectId: "webtest-cffc9",
    storageBucket: "webtest-cffc9.appspot.com",
    messagingSenderId: "563831032373",
    appId: "1:563831032373:web:b0d36a5ed9a121d3b33f7c"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);

  let currentFloor = 3;

  let floors = [];
  floors[3] = 'siwb3.svg'
  floors[4] = 'siwb4.svg'

  let urls = []
  urls[3] = '';
  urls[4] = '';

  const viewFloor = floor => {
    
   // saveFile()
   saveFile(currentFloor).then(url => {
     console.log("Saved file", url)
     currentFloor = floor;
     loadFile(urls[floor])
   });
   
   
  
  }

  const saveFile = async floor => {
    return new Promise((resolve, reject) => {
      const svg = document.getElementById("svg");
      const svgData = new XMLSerializer().serializeToString(svg);
      const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
      const svgUrl = URL.createObjectURL(svgBlob);
      const storage = getStorage();
      const storageRef = ref(storage, floors[floor]);
      uploadBytes(storageRef, svgBlob).then((snapshot) => {
        getDownloadURL(storageRef).then(url => {
          urls[floor] = url;
          console.log("Saved file: " + url)
          resolve(url)
        }).catch(error => reject(error))
      }).catch(error => reject(error))
    });
  
  }

  const loadFile = file => fetch(file)
    .then(response => response.text())
    .then(svg => {
      console.log(file);
      console.log("Loaded file")
      document.getElementById("container").innerHTML = svg;
      document.getElementById("container").firstChild.id = "svg";
      main();
    });

  const main = () => {
    let isDragging = false;
    const svg = document.getElementById('svg');
    const NS = "http://www.w3.org/2000/svg"

    let initialX = 0;
    let initialY = 0;
    let xOffset = 0;
    let yOffset = 0;

    svg.addEventListener('mousedown', startDrag);
    svg.addEventListener('touchstart', startDrag);
    svg.addEventListener('mousemove', drag);
    svg.addEventListener('touchmove', drag);
    svg.addEventListener('mouseup', endDrag);
    svg.addEventListener('mouseleave', endDrag);
    svg.addEventListener('touchend', endDrag);

    function startDrag(e) {

      e.preventDefault();

      if (e.type === 'touchstart') {
        initialX = e.touches[0].clientX - xOffset;
        initialY = e.touches[0].clientY - yOffset;
      } else {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;
      }

      isDragging = true;
    }

    function drag(e) {

      e.preventDefault();

      if (isDragging) {

        if (e.type === 'touchmove') {
          xOffset = e.touches[0].clientX - initialX;
          yOffset = e.touches[0].clientY - initialY;
        } else {
          xOffset = e.clientX - initialX;
          yOffset = e.clientY - initialY;
        }
        svg.style.transform = `translate(${xOffset}px, ${yOffset}px)`;

      }
    }

    function endDrag() {
      isDragging = false;
    }

    svg.addEventListener('click', (e) => {

      if (!e.target.closest('#svg')) {
        return
      }

      if (isDragging) {
        return;
      }

      const pt = svg.createSVGPoint();

      // pass event coordinates
      pt.x = e.clientX;
      pt.y = e.clientY;

      // transform to SVG coordinates
      const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());

      // add new SVG element
      const circle = document.createElementNS(NS, 'circle');
      circle.setAttribute('cx', svgP.x);
      circle.setAttribute('cy', svgP.y);
      circle.setAttribute('r', 10);
      circle.setAttribute('fill', 'red');

      svg.appendChild(circle);
    });

  }

  loadFile('siwb3.svg')

  //loadFile('siwb4.svg')
  document.addEventListener("keyup", function (event) {
    if (event.key === "s") {
      saveFile('siwb3.svg');
    }
  });
  document.addEventListener("keyup", function (event) {
    if (event.key === "a") {
      viewFloor(3);
    }
  });
</script>

</html>